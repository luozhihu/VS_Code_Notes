关于端口，牵扯到下面几个问题
- 多个TCP进程可以使用同一个端口吗
- 重启TCP进程出现Adderss in use的错误
- 客户端的端口可以重复使用吗
- 客户端TCP连接太多TIME_WAIT会导致端口耗尽吗

> TCP与UDP可以绑定相同的端口吗

答案是：**可以的**

在传输层，操作系统为TCP和UDP提供的不是同一个模块，所以端口也是相互独立的。

![[Pasted image 20250905215723.png]]

> 不同的应用可以绑定同一个TCP端口吗

答案是：**可以的**

需要保证(源ip，源端口，目的ip，目的端口)唯一性，就可以建立相同的源端口TCP连接。

> 重启 TCP 服务进程时，为什么会有“Address in use”的报错信息？

当重启服务器的时候，服务器作为主动关闭连接的一方，需要等待TIME_WAIT时间（2MSL）才能断开连接，而这个时间内所占用的端口任然被认为是有效的连接。这个时候要重新绑定这个端口就会报端口重复的错误。

> 重启 TCP 服务进程时，如何避免“Address in use”的报错信息？

我们可以在调用 bind 前，对 socket 设置 SO_REUSEADDR 属性

如果当前启动进程绑定的 IP+PORT 与处于TIME_WAIT 状态的连接占用的 IP+PORT 存在冲突，但是新启动的进程使用了 SO_REUSEADDR 选项，那么该进程就可以绑定成功。

> 多个客户端可以 bind 同一个端口吗？

答案是：**可以的**

可以通过bind函数主动绑定一个端口，这样在connet()的时候就会跳过分配端口的阶段了。

> 客户端 TCP 连接 TIME_WAIT 状态过多，会导致端口资源耗尽而无法建立新的连接吗？

答案是：看情况

- TIME_WAIT状态的连接都是绑定一个服务器的：端口耗尽，无法建立新的连接。
- TIME_WAIT状态的连接绑定的都是不同的服务器：可以建立新的连接。

> 如何解决客户端 TCP 连接 TIME_WAIT 过多，导致无法与同一个服务器建立连接的问题？

- 如果**没有开启** net.ipv4.tcp_tw_reuse 内核参数，那么内核就会选择下一个端口，然后继续判断，直到找到一个没有被相同四元组的连接使用的端口，如果端口资源耗尽还是没找到，那么 connect 函数就会返回错误。
- 如果**开启**了 net.ipv4.tcp_tw_reuse 内核参数，就会判断该四元组的连接状态是否处于 TIME_WAIT 状态，**如果连接处于 TIME_WAIT 状态并且该状态持续的时间超过了 1 秒，那么就会重用该连接**，于是就可以使用 2222 端口了，这时 connect 就会返回成功。
