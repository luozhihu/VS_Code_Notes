> 为什么 TCP 每次建立连接时，初始化序列号都要不一样呢？

主要原因是为了防止历史报文被下一个相同四元组的连接接收。

> TCP 四次挥手中的 TIME_WAIT 状态不是会持续 2 MSL 时长，历史报文不是早就在网络中消失了吗？

是的，但是来了，我们并不能保证每次连接都能通过四次挥手来正常关闭连接。

![alt text](image-57.png)

> 客户端和服务端的初始化序列号不一样不是也会发生这样的事情吗？

是的，即使客户端和服务端的初始化序列号不一样，也会存在收到历史报文的可能。我们要清楚一点，历史报文的序列号是否正好在对方接收窗口内，如果不在就会丢弃，如果在才会接收。

所以，即使每次建立连接时的序列号都不一样，也有小概率的发送的历史报文的序列号正好在对方的接收窗口内。

> 如果客户端和服务端初始化序列号都是递增且随机生成的话，就能避免连接接收历史报文了？

是的，但是序列号和确认号只有32位，序列号是一个 32 位的无符号数，因此在到达 4G 之后再循环回到 0。所以序列号和初始化序列号并不是无限递增的，会发生回绕为初始值的情况，在高速的网络中，序列号的回绕时间会变得很短。

为了解决这个问题，就需要有 TCP 时间戳。tcp_timestamps 参数是默认开启的，它有两个好处，一个是便于精确计算 RTT ，另一个是能防止序列号回绕（PAWS）。
